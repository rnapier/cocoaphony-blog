
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Avoiding Timing Attacks on NSData - Cocoaphony</title>
  <meta name="author" content="Rob Napier">

  
  <meta name="description" content="Most comparison functions look something like this more or less: BOOL compare(uint8_t *a, size_t aLen, uint8_t *b, size_t bLen) { if (aLen != bLen &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://localhost:4000/avoiding-timing-attacks-on-nsdata">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Cocoaphony" type="application/atom+xml">
  <link href="https://micro.blog/cocoaphony" rel="me" />
  <link href="https://twitter.com/cocoaphony" rel="me" />
  <link href="https://github.com/robnapier" rel="me" />
  <!-- <script src="/javascripts/modernizr-2.0.js"></script> -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <!-- <script src="/javascripts/octopress.js" type="text/javascript"></script> -->
  <script src='/javascripts/footnotes.js' type="text/javascript"></script>

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoaphony</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Avoiding Timing Attacks on NSData</h1>
    
    
      <p class="meta">
        









<time datetime="2014-01-24T13:48:22-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Most comparison functions look something like this more or less:</p>

<pre><code class="objc">BOOL compare(uint8_t *a, size_t aLen, uint8_t *b, size_t bLen) {
  if (aLen != bLen) {
    return NO;
  }

  for (size_t i = 0; i &lt; aLen; ++i) {
    if (a[i] != b[i]) {
      return NO;
    }
  }
  return YES;
}
</code></pre>

<p>If the lengths are different, then they&rsquo;re not equal. Otherwise compare each element. If you find a mismatch, they&rsquo;re not equal. If at the end of the search, there were no mismatches, then they&rsquo;re equal. That&rsquo;s a fine comparison function. The same basic idea will work for for an <code>NSArray</code> or a <code>std::vector</code> or an <code>NSString</code>. The <code>std::equal</code> algorithm is basically the same (except for checking length equality).</p>

<p>Basic stuff. Very efficient. Also the source of a common security mistake: the timing attack. It looks like this:</p>

<pre><code>- (BOOL)isAuthorizedWithKey:(NSData *)providedKey {
  return [providedKey isEqual:kSecretKeyData];
}
</code></pre>

<p>So simple. Who could imagine it&rsquo;s a problem? And in many cases (especially on iOS), it may not be exploitable. But let&rsquo;s see how an attacker can use this:</p>

<ul>
<li>Send the key 0x00 many times and keep track of how long it takes to fail.</li>
<li>Send the key 0x00 0x00 many times and keep track of how long it takes to fail.</li>
<li>Keep expanding the key by one byte.</li>
<li>If the test function checks lengths, then the failure time will be slightly longer when your guess matches the length of the actual key. Now you know the length.</li>
<li>Send the key (of the known length) containing just 0x00. Again, try it many times and track how long it takes to fail.</li>
<li>Change the first byte to 0x01 and repeat.</li>
<li>Continue changing the first byte until the failure takes slightly longer. Now you know the first byte.</li>
<li>Repeat for the rest of the bytes.</li>
</ul>


<p>While this requires a lot of tests, it will still be a tiny fraction of the number of tests required to brute force the whole keyspace. For example, even if you need 1,000,000 tests per guess to work out the average, the worst-case  will be:</p>

<p>$$1,000,000 \times 256 \times length \ll 256^{length} \quad (length > 4)$$</p>
</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Rob Napier</span></span>

      









<time datetime="2014-01-24T13:48:22-05:00" pubdate data-updated="true"></time>
      


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/pinning-your-ssl-certs" title="Previous Post: Pinning your SSL Certs">&laquo; Pinning your SSL Certs</a>
      
      
        <a class="basic-alignment right" href="/renaissance-2014-materials" title="Next Post: Renaissance 2014 Materials">Renaissance 2014 Materials &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - <a href="mailto:rob@neverwood.org">Rob Napier</a> - <a href="https://twitter.com/cocoaphony">@cocoaphony</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  








<!-- Fathom - simple website analytics - https://usefathom.com -->
<script>
(function(f, a, t, h, o, m){
a[h]=a[h]||function(){
    (a[h].q=a[h].q||[]).push(arguments)
};
o=f.createElement('script'),
m=f.getElementsByTagName('script')[0];
o.async=1; o.src=t; o.id='fathom-script';
m.parentNode.insertBefore(o,m)
})(document, window, '//cdn.usefathom.com/tracker.js', 'fathom');
fathom('set', 'siteId', 'MSRAZWIU');
fathom('trackPageview');
</script>
<!-- / Fathom -->



</body>
</html>
