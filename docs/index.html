
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Cocoaphony</title>
  <meta name="author" content="Rob Napier">

  
  <meta name="description" content="You&rsquo;re not alone. Swift protocols confuse us all. This is going to be a fairly long series, in words if not in number of posts. I tend to &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://localhost:4000">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Cocoaphony" type="application/atom+xml">
  <link href="https://micro.blog/cocoaphony" rel="me" />
  <link href="https://twitter.com/cocoaphony" rel="me" />
  <link href="https://github.com/robnapier" rel="me" />
  <!-- <script src="/javascripts/modernizr-2.0.js"></script> -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <!-- <script src="/javascripts/octopress.js" type="text/javascript"></script> -->
  <script src='/javascripts/footnotes.js' type="text/javascript"></script>

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoaphony</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/you're-not-alone">You're Not Alone</a></h1>
    
    
      <p class="meta">
        









<time datetime="2019-04-22T12:04:22-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>You&rsquo;re not alone. Swift protocols confuse us all.</h2>

<p>This is going to be a fairly long series, in words if not in number of posts. I tend to ramble a bit about philosophy, and there will be quite a lot of code. Usually I&rsquo;d let the important points reveal themselves along the path. But Swift protocols are too important to let the most critical points be buried in mountains of text, so I&rsquo;m going to
reveal all the important points here before I get started. If I forget something, I may come back and update this section. Also, if the statements in this list are either obvious to you, or not interesting, this series probably isn&rsquo;t for you.</p>

<ul>
<li>Write concrete code first. Then work out the generics.</li>
<li>Do not create &ldquo;genericness&rdquo; for its own sake. Discover it in your concrete use case.</li>
<li>Abstractions are choices. They cut you off from other abstractions. &ldquo;As generic as possible&rdquo; doesn&rsquo;t mean anything.</li>
<li>The point of a PAT is to apply generic algorithms to a type. It is never to create a heterogeneous collection.</li>
<li>Simple (non-PAT) protocols are commonly used to create a heterogeneous collection</li>
<li>Before you add an associated type, ask: &ldquo;Would it be sensible to put this type in an array?&rdquo; If the answer is yes, do not add an associated type. Redesign.</li>
<li>You probably don&rsquo;t need a type-eraser. If you&rsquo;re trying to put a PAT in an array, you <em>definitely</em> don&rsquo;t need a type-eraser. Redesign.</li>
<li>Generalized existentials probably will not solve your problem. Redesign.</li>
<li>Protocols are not abstract classes. Swift doesn&rsquo;t have abstract classes. If your protocol inheritance would make perfect sense as an abstract class hierarchy, you&rsquo;re probably on the wrong road.</li>
<li>Protocols (almost) never conform to protocols. When you need &ldquo;a type that conforms to P,&rdquo; P is not that type.</li>
<li>A protocol cannot <em>be</em> Equatable. It can only <em>require</em> Equatable.</li>
<li>Aspire to more than &ldquo;mocks&rdquo; from your protocols.</li>
<li>Protocols are not bags of syntax. They have have semantics (meanings) and exist to facilitate interesting algorithms.</li>
</ul>


<p>That&rsquo;s a lot to talk about, and this will be a dense and meandering series. It&rsquo;s time to dive into it. This article will just set the stage. I&rsquo;ve been wrestling with protocols since the the first day of Swift. I&rsquo;ve used them incorrectly and had to redesign so many times I&rsquo;ve lost count. I&rsquo;ve crashed the compiler so many times that it&rsquo;s lost count. You are not alone.</p>

<hr />

<h2>Revisiting Crusty</h2>

<p>About half the Crusty talk revolves around one long example, a “diagramming app where you can drag and drop shapes on a drawing surface and interact with them.” It’s a very classic object-oriented problem, and in an OOP language I&rsquo;d probably focus on laying out the model classes first. Maybe something like this:</p>

<pre><code>class Shape {
    var center: CGPoint
    init(center: CGPoint) {
        self.center = center
    }
}

class Circle : Shape {
    var radius: CGFloat
    init(center: CGPoint, radius: CGFloat) {
        self.radius = radius
        super.init(center: center)
    }
}
</code></pre>

<p>That feels ok at first glance, but it actually has some pretty major problems already. Yes, there&rsquo;s the reference/value type arguments about unintentional sharing and mutable state, but that&rsquo;s not really my focus here. We could make these types immutable and make those problems go away (creating other problems, but still&hellip;.) The real problem in my opinion is the <code>center</code> property. What happens when I try to implement Polygon?</p>

<pre><code>class Polygon : Shape {
    var corners: [CGPoint]
    init(corners: [CGPoint]) {
        self.corners = corners
        super.init(center: ???) // What is the center?
    }
}
</code></pre>

<p>Is the center the <a href="https://en.wikipedia.org/wiki/Centroid">centroid</a>, or the center of the bounding box? It&rsquo;s implemented as a property in Shape, so every subclass must maintain it as a property and keep it in sync with any changes to other properties. Is it even used by anything? Do we need to make these decisions yet?</p>

<p>The problem with class inheritance is that it pushes you to make all these choices early, before you&rsquo;ve worked out your use cases. The power of protocol-oriented programming is that it lets you make these decisions late. In Swift, I&rsquo;ve learned to implement Circle and Polygon this way:</p>

<pre><code>struct Circle {
    var center: CGPoint
    var radius: CGFloat
}

struct Polygon {
    var corners: [CGPoint]
}
</code></pre>

<p>That&rsquo;s it. No protocols. No inheritance. Nothing. It&rsquo;s data, stored in whatever is convenient for that data. But I probably wouldn&rsquo;t create these at all, yet. I don&rsquo;t know what I&rsquo;m going to do with this data. Instead of starting with models, start with the caller.</p>

<p>My goal is to draw &ldquo;things&rdquo; of some kind in a CGContext:</p>

<pre><code>for thing in things {
    thing.draw(in: context)
}
</code></pre>

<p>What should I call these Things? Shapes? Kind of, but that&rsquo;s not really what defines them here. They&rsquo;re just &ldquo;something that can draw itself into a context.&rdquo; And they need exactly one method, <code>draw</code>, so Drawable is a good name.</p>

<pre><code>protocol Drawable {
    func draw(in context: CGContext)
}
</code></pre>

<p>Some of you have seen Crusty&rsquo;s talk and you might be shouting &ldquo;no, no, not CGContext. You want Renderer.&rdquo; But I don&rsquo;t, at least not yet. That isn&rsquo;t my use case. I just need to draw &ldquo;drawable things&rdquo; in a CGContext. Build simply. Then find your protocols. I&rsquo;m hoping this is going to work out, but to be sure, I should make a few of these Drawables and see if this idea makes sense.</p>

<p>The simplest thing to draw is a circle, so I&rsquo;m hoping this is easy to draw:</p>

<pre><code>extension Circle : Drawable {
    func draw(in context: CGContext) {
        context.addArc(center: center, radius: radius,
                       startAngle: 0, endAngle: .pi*2,
                       clockwise: true)
    }
}
</code></pre>

<p>Looks good. That&rsquo;s exactly the kind of to-the-point method I expect in order to implement Drawable.</p>

<pre><code>extension Polygon : Drawable {
    func draw(in context: CGContext) {
      context.move(to: corners.last!)
      for p in corners { context.addLine(to: p) }
    }
}
</code></pre>

<p>And again, looking very good and to-the-point. We should try something a little different, like a container for other Drawables:</p>

<pre><code>struct Diagram {
    mutating func add(_ other: Drawable) {
        elements.append(other)
    }

    var elements: [Drawable] = []
}

extension Diagram: Drawable {
    func draw(in context: CGContext) {
        for f in elements { f.draw(in: context) }
    }
}
</code></pre>

<p>Again, this looks very straight forward. It&rsquo;s important to try to conform several kinds of types early in the process. You want to find where your protocol might run into trouble. If all you implement are the trivial types, then there may be major problems lurking in your design. For example, here&rsquo;s a Drawable that Crusty didn&rsquo;t consider:</p>

<pre><code>struct Text {
    var position: CGPoint
    var attributedString: NSAttributedString
}

extension Text: Drawable {
    func draw(in context: CGContext) {

        // Configure the context
        context.textMatrix = .identity
        context.textPosition = position

        // Draw the text
        let line = CTLineCreateWithAttributedString(attributedString)
        CTLineDraw(line, context)
    }
}
</code></pre>

<p>That&rsquo;s actually a bit complicated. It&rsquo;s only four lines, but it already makes me a little nervous. I know I want to swap out CGContext at some point, but this requires Core Text functions that aren&rsquo;t part of CGContext. That tells me it&rsquo;s time to start thinking about abstracting CGContext before this gets out of hand.</p>

<hr />

<blockquote><blockquote><p>Another case is where the instances of the abstraction are just &ldquo;sinks.&rdquo; Like, our Renderers, for example. So, we&rsquo;re just pumping, we&rsquo;re just pumping information into that thing, into that Renderer, right?
<a href="https://developer.apple.com/videos/play/wwdc2015/408/?time=2643">https://developer.apple.com/videos/play/wwdc2015/408/?time=2643</a>
Dave Abrahams (Crusty)</p></blockquote></blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/start-with-a-protocol">Protocols I: Start With a Protocol</a></h1>
    
    
      <p class="meta">
        









<time datetime="2019-04-22T00:00:00-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>In the beginning, Crusty</h2>

<p>In 2015, at WWDC, <a href="https://twitter.com/DaveAbrahams">Dave Abrahams</a> gave what I believe is still the greatest Swift talk ever given, and certainly the most influential. <a href="https://developer.apple.com/videos/play/wwdc2015/408/">”Protocol-Oriented Programming in Swift,”</a> or as it is more affectionately known, “The Crusty Talk.”</p>

<p>This is the talk that introduced the phrase “protocol oriented programming.” The first time I watched it, I took away just one key phrase:</p>

<blockquote><p>Start with a protocol.</p></blockquote>

<p>And so, dutifully, I started with a protocol. I made a UserProtocol and a DocumentProtocol and a ShapeProtocol and on and on, and then started implementing all those protocols with generic subclasses and eventually I found myself in a corner.</p>

<pre><code>Protocol 'P' can only be used as a generic constraint because it has Self or associated type requirements
</code></pre>

<p>And then I started throwing things.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/start-with-a-protocol">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/agile">Platitudes and Manifestos</a></h1>
    
    
      <p class="meta">
        









<time datetime="2018-02-25T00:00:00-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I had a brief <a href="https://twitter.com/cocoaphony/status/967801456962297856">Twitter discussion</a> about Agile and it got me thinking about what&rsquo;s worked and hasn&rsquo;t worked in my teams. I&rsquo;ve been a professional developer for about 30 years now. I&rsquo;ve worked on a few dozen products with about 20 different teams.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/conditional-breakpoint">A Conditional Breakpoint</a></h1>
    
    
      <p class="meta">
        









<time datetime="2017-04-23T11:59:20-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://twitter.com/jamesdempsey/status/855979622655291392">I&rsquo;m now a Conditional Breakpoint.</a> It&rsquo;s been a dream of mine for long time, and it finally happened at <a href="http://cocoaconf.com/chicago-2017/sessions/breakpoint-jam">CocoaConf Chicago</a>. There are folks who have played extensively with <a href="http://jamesdempsey.net/2013/03/02/introducing-the-breakpoint-jam-at-cocoaconf-chicago/">James Dempsey</a>, and those are the Breakpoints. If you&rsquo;ve only played occasionally (even once), you&rsquo;re a Conditional Breakpoint.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/conditional-breakpoint">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/refactoring">Refactoring Slow and Steady</a></h1>
    
    
      <p class="meta">
        









<time datetime="2017-02-13T12:21:55-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve been talking with folks on a Slack about refactoring today, and I thought I&rsquo;d put some of my thoughts here. Maybe a little less polished than I&rsquo;d like, but I wanted to get them out of my head and down on &ldquo;paper.&rdquo;</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/refactoring">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/dates">La Trahison Du Temps</a></h1>
    
    
      <p class="meta">
        









<time datetime="2016-12-17T14:01:59-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p style="text-align:center;"><img src="/images/trahison.png" alt="La Trahison du Temps" /></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/dates">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/dates-orig">La Trahison Du Temps</a></h1>
    
    
      <p class="meta">
        









<time datetime="2016-12-17T14:01:59-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p style="text-align:center;"><img src="/images/trahison.png" alt="La Trahison du Temps" /></p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/dates-orig">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/talking">Talking and Teaching</a></h1>
    
    
      <p class="meta">
        









<time datetime="2016-11-29T10:35:09-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="https://twitter.com/pepibumur">Pedro Piñera</a> makes some important points in his article <a href="http://ppinera.es/2016/11/16/in-a-world.html">In a world&hellip;</a>. There are a number of things in there, and you should go read it, but I want to focus on one part, which is the observation that the core &ldquo;iOS speaker circle&rdquo; is a fairly small group of people. Pedro notes:</p>

<blockquote><p>There’s a huge difference when you compare a talk from someone that has been working a lot on the topic and from someone that studied the topic for giving a talk. Why do people do it then? Talks with a lot of value usually come from unknown people. From these people that from the anonymity worked on a topic and they achieved something that they were willing to share. &hellip; People don’t care about the company that person had worked for, or the newsletter that the person had written, but instead, what that person wants to share.</p></blockquote>

<p>While I agree with Pedro&rsquo;s concern, I disagree that this is the proper ideal.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/talking">Read on &rarr;</a>
    </footer>
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/new-developer-advice">New Developer Advice</a></h1>
    
    
      <p class="meta">
        









<time datetime="2016-10-18T11:27:04-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>D.J. wrote to ask a question, and I figured others might have the same one, so I&rsquo;d write it once here.</p>

<blockquote><p>I was wondering if you would be so kind as to offer some advice to a fledgling iOS developer! I am hoping to get my first job in iOS development soon.</p></blockquote>

<p>Welcome to the community! I love that we are a community, and I think becoming a part of it is an important piece in becoming a great developer. iOS changes so fast and so often, that no one can really be an expert in all of it. We rely on each other to teach us the parts we don&rsquo;t know yet. And there so many new parts that even newcomers can become the expert in this or that piece. Every new &ldquo;Kit&rdquo; (GameKit, SpriteKit, CarKit, whatever) is a new world no one has explored yet. Every new platform (watches, TVs, who knows what&rsquo;s next) is another opportunity.</p>

<p>I keep seeing people bring new ideas. Functional and reactive programming. Server-side Swift. Just this year I&rsquo;ve met people building ray tracers and neural nets. You can even work on the Swift language itself. The team marks &ldquo;bugs for beginners&rdquo; <a href="https://bugs.swift.org/browse/SR-2961?jql=labels%20%3D%20StarterBug">StarterBug</a> so you can find them easily.  There are so many things that no one has built yet, and every time Swift changes we have to figure out again &ldquo;what is good Swift?&rdquo; So we&rsquo;re all learning (and stumbling, and re-learning) all the time. It&rsquo;s a great time to jump in.</p>

<p>We are a community. I&rsquo;m probably biased because I hang out on <a href="https://twitter.com/cocoaphony">Twitter</a>, but I think we hang out on Twitter. We hang out in <a href="http://cocoaheads.org">CocoaHeads</a> meetings. <a href="http://cocoaconf.com">We</a> <a href="http://www.dotswift.io">hang</a> <a href="http://www.tryswiftnyc.com">out</a> <a href="http://do-ios.com">in</a> <a href="https://www.playgroundscon.com">lots</a> <a href="http://nsscotland.com">and</a> <a href="http://pragmamark.org">lots</a> <a href="http://360idev.com">of</a> <a href="http://nsspain.com">conferences</a>. <a href="https://swiftconf.com">Oh</a>, <a href="http://nsnorth.ca">so</a> <a href="https://swiftsummit.com">many</a> <a href="http://www.uikonf.com">conferences</a>. Go to the places we hang out. Talking to other iOS developers will make you a better developer. Ask questions. We&rsquo;re mostly kind, though not always as kind as we should be. Be kind, and remind us when we forget.</p>

<p>I learned the most about Cocoa by answering Stack Overflow questions. It wasn&rsquo;t that I knew a lot so I answered questions. It&rsquo;s that I answered questions so I learned a lot. I picked questions that seemed interesting and I researched the answer. It doesn&rsquo;t matter whether you get reputation or not. The worst thing that happens is someone else answers the question sooner or better than you do, and you learn something new anyway.</p>

<p>Learn to read ObjC. You do not need to learn how to write it. It is our Latin. So much Cocoa knowledge, from blog posts to documentation to Stack Overflow, is written in ObjC. Don&rsquo;t just wait for someone to translate it for you.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/copying">Copying</a></h1>
    
    
      <p class="meta">
        









<time datetime="2016-09-03T13:56:14-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;m on my way back from <a href="http://tryswiftnyc.com">try! Swift</a>, which was fantastic. Of course it had those obvious things I&rsquo;d hope for. Interesting talks, friendly people. Making new friends, and reuniting with old ones. But it also had some surprising delights and lessons.</p>

<p>I travel pretty well, but sometimes I make mistakes, and this was one of those times. The deodorant I thought I&rsquo;d packed turned out to be body wash. Now there are a dozen reason that this shouldn&rsquo;t really matter, and wouldn&rsquo;t really matter given the A/C and the weather, etc., but I&rsquo;m a product of my culture, and it was a bit stressful. I tried to find a drug store on the way to the conference, but I was afraid of being late and finally resigned myself to accepting things as they are and moving on.</p>

<p>And then, in the conference rest room, I discovered a small cache of toiletries under a try! Swift sign saying &ldquo;if you need one, please take one.&rdquo; I was dumbfounded. It was a very small kindness, but it mattered to me.</p>

</div>
  
  
    <footer>
      <a rel="full-article" href="/copying">Read on &rarr;</a>
    </footer>
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/page2">&larr; Older</a>
    
    <a href="/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    
  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - <a href="mailto:rob@neverwood.org">Rob Napier</a> - <a href="https://twitter.com/cocoaphony">@cocoaphony</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  








<!-- Fathom - simple website analytics - https://usefathom.com -->
<script>
(function(f, a, t, h, o, m){
a[h]=a[h]||function(){
    (a[h].q=a[h].q||[]).push(arguments)
};
o=f.createElement('script'),
m=f.getElementsByTagName('script')[0];
o.async=1; o.src=t; o.id='fathom-script';
m.parentNode.insertBefore(o,m)
})(document, window, '//cdn.usefathom.com/tracker.js', 'fathom');
fathom('set', 'siteId', 'MSRAZWIU');
fathom('trackPageview');
</script>
<!-- / Fathom -->



</body>
</html>
