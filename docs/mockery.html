
<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <title>A Mockery of Types - Cocoaphony</title>
  <meta name="author" content="Rob Napier">

  
  <meta name="description" content="I’m going to talk about testing over the next few posts. If you’ve talked to me at any length over the last several years, you know I’ve been &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://robnapier.net/mockery">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css?date=2024-05-18" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Cocoaphony" type="application/atom+xml">
  <link href="https://micro.blog/cocoaphony" rel="me" />
  <link href="https://twitter.com/cocoaphony" rel="me" />
  <link href="https://mastodon.social/@cocoaphony" rel="me" />
  
</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoaphony</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
  <li><a href="/talks">Talks</a></li>
  <li><a href="https://cocoaphony.micro.blog">micro.blog</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">A Mockery of Types</h1>
    
    
      <p class="meta">
        








<time datetime="2025-05-14T21:21:00-04:00" pubdate data-updated="true">14 May 2025</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>I’m going to talk about testing over the next few posts. If you’ve talked to me at any length over the last several years, you know I’ve been thinking a lot about testing, and I have somewhat unorthodox opinions. Unorthodox enough that I really haven’t wanted to write them down because I’m really not trying to start an argument. If your approach to testing works for you and your team, I think you’re doing it right and I don’t think you should change just because I do it a different way.</p>

<p>But if you and your team struggle with testing and you think it’s because you lack the discipline to “do things right,” I’d like to offer another way of thinking about testing that has worked very well for many years, for several teams, and in multiple languages. In this series I’m going to focus specifically on iOS development working in Swift. Some topics are different in other environments. I might touch on those eventually, but to keep this already sprawling topic bounded, I’m going to stick to client-side Swift for now.</p>

<p>So none of this may apply to you. But if you feel that your current testing approach isn’t working, I’d like to offer another option:</p>

<p><em>Mock as little as you can. Mock only at the edges. Minimize dependency injection. Test real code.</em></p>

<!-- more -->

<p>This is the point in the conversation at which many a good and wise friend has, with great kindness, called me an idiot. And before I’m done, you might too. And that’s fine. If your fancy DI framework is working for you, you shouldn’t abandon it. Maybe listen to some of my philosophical points and ignore the rest. Or ignore it all. I’m warning you up front where this is headed.</p>

<p>But the best thing I’ve done for testing in multiple code bases has been to delete nearly all the mocks and mostly remove dependency injection. In the process, I’ve also made production code better. I’ve spent the last few months removing mocks from my current project while also improving test code coverage by tens of thousands of lines. Tests are simpler to write and they actually test real things. It’s possible to do a lot of testing with very little mocking.</p>

<p>I want to start this series with a concrete example: a Keychain wrapper. We’ve all used them. I’ve worked with many on several teams (and sometimes several on the same team), and this example is based on lessons learned from all of them.</p>

<p><span class="pullquote-right" data-pullquote="We need to be able to test things that aren&#8217;t perfect.">
You’re going to look at this wrapper and think “that’s not an ideal design,” and you’re right. But it’s the kind of design you’ll find in real code bases. We need to be able to test things that aren’t perfect. You don’t need to read it all now. The comments at the top are enough, and I’ll explain the API along the way.
</span></p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage1/Keychain/Sources/Keychain/Keychain.swift"><em>Source code</em></a></p>

<div class="language-swift scroll highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">/// A Keychain wrapper that offers key/value storage with the following features:</span>
<span class="c1">///</span>
<span class="c1">/// * Takes an identifier to maintain separate stores</span>
<span class="c1">/// * Each Keychain offers independent key/value storage</span>
<span class="c1">/// * Caches values in memory for performance</span>
<span class="c1">/// * Allows reading and writing Data directly</span>
<span class="c1">/// * Encodes Strings as UTF-8</span>
<span class="c1">/// * Encodes JSONSerialization-compatible types (except String and Data) as JSON</span>
<span class="c1">/// * Supports "reset" to delete all keys for this identifier</span>
<span class="c1">///</span>
<span class="kd">public</span> <span class="kd">actor</span> <span class="kt">Keychain</span> <span class="p">{</span>
  <span class="kd">public</span> <span class="k">let</span> <span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nv">cache</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Data</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>

  <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span> <span class="p">}</span>

  <span class="c1">// MARK: - Data Operations</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
    <span class="c1">// First check the cache</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">data</span>
    <span class="p">}</span>

    <span class="c1">// That terrible `SecItemCopyMatching` call you all know...</span>
    <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">_data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>

    <span class="c1">// And cache it for later</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">return</span> <span class="n">data</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// Set it to the cache and to system keychain</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">try</span> <span class="nf">_set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// Remove it from the cache and the system keychain</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">try</span> <span class="nf">_removeData</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// Clear the cache and delete all keys for this identifier</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="k">try</span> <span class="nf">_reset</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="c1">// MARK: - String Operations -- Encode as UTF-8</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">string</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="kt">String</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">utf8</span><span class="p">),</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// MARK: - JSONSerialization Operations</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">fragmentsAllowed</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kt">Any</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">withJSONObject</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">fragmentsAllowed</span><span class="p">])</span>
    <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// MARK: - Public Extensions for Common Types (Bool, Int)</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">bool</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">value</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">bool</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">bool</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">int</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Int</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">value</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Int</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">int</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">int</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>

  <span class="c1">// MARK: - All those horrible low-level SecItem... wrappers that I'm not going to bore you with</span>

  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">_data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span> 
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">_set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">_removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="kd">private</span> <span class="kd">func</span> <span class="nf">_reset</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Some key points to this code that will come up later:</p>

<ul>
  <li>Calling <code class="language-plaintext highlighter-rouge">set(string:forKey:)</code> encodes the value differently than <code class="language-plaintext highlighter-rouge">set(value:forKey:)</code> when passing a <code class="language-plaintext highlighter-rouge">String</code>. In some cases, a mismatch will lead to returning the wrong value (quoted vs not-quoted). In other cases it may return <code class="language-plaintext highlighter-rouge">nil</code>. “Well that’s awkward. Let’s fix it!” But remember, this code has shipped. Millions of keys have already been written to user keychains. If you change the encoding, you’ll need to write a migrator. There may be other code that has hacked around the current behavior and will break if you change it (ask me why I think that might happen…). Before you go redesigning a critical piece of persistent storage, it sure would be nice to have tests, right? As much as we can, we want a testing approach that can deal with things as they are, not just how they should be.<sup id="fnref:why"><a href="#fn:why" class="footnote" rel="footnote" role="doc-noteref">1</a></sup></li>
</ul>

<ul>
  <li>This code cannot be called from a unit test on any platform but macOS if the test lives in an SPM package (rather than a hosted application). To access the system keychain, even on Simulator, requires an entitlements file, and SPM can’t provide it. That means that some kind of “mocking” solution is absolutely required for any non-macOS SPM code that relies on <code class="language-plaintext highlighter-rouge">Keychain</code>. It’s literally impossible to test otherwise. The point of this series isn’t “never mock.” It’s to reduce mocking as much as we can.</li>
</ul>

<p><span class="pullquote-right" data-pullquote="We do not write tests for virtue&#8217;s sake.">
For the moment, I want to ignore how we test <code class="language-plaintext highlighter-rouge">Keychain</code> itself. Maybe it’s been around for years and you’ve never had any bugs from it. Should you even write tests at that point? Meh? We do not write tests for virtue’s sake. They are work, and we need to have a reason to write them. In a later post I’ll discuss the many different reasons to write tests, but chasing ever-higher code coverage isn’t one of them.
</span></p>

<p>I want to start by testing things that <em>use</em> <code class="language-plaintext highlighter-rouge">Keychain</code>. Since using <code class="language-plaintext highlighter-rouge">Keychain</code> completely breaks unit tests for iOS, we need to do something.</p>

<p>So, I’m going to reach for the tool you’re all thinking of. <a href="/a-mockery-of-protocols">It’s the wrong tool</a>, but it’s <a href="/start-with-a-protocol">where we all start</a>. I’m going to make a protocol!</p>

<h2 id="abusing-protocols-for-tests-and-dubious-profit">Abusing Protocols for Tests and (Dubious) Profit</h2>

<p>Here we go. Each public method becomes a protocol requirement:</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage2/Keychain/Sources/Keychain/KeychainProtocol.swift"><em>Source code</em></a></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">KeychainProtocol</span><span class="p">:</span> <span class="kt">Actor</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
  <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
  <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span>

  <span class="kd">func</span> <span class="nf">string</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>

  <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Any</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kt">Any</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>

  <span class="kd">func</span> <span class="nf">bool</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">bool</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>

  <span class="kd">func</span> <span class="nf">int</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Int</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">int</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
<span class="p">}</span>
</code></pre></div></div>
<p>And we build a mock. Because we always need a mock that implements every single part of the subject:</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage2/Keychain/Sources/Keychain/MockKeychain.swift"><em>Source code</em></a></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">actor</span> <span class="kt">MockKeychain</span><span class="p">:</span> <span class="kt">KeychainProtocol</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nv">storage</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Data</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>

  <span class="c1">//</span>
  <span class="c1">// Data accessors</span>
  <span class="c1">//</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span> <span class="n">storage</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span> <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Codable accessors</span>
  <span class="c1">//</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">string</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">decode</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">store</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">bool</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">decode</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">bool</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">store</span><span class="p">(</span><span class="n">bool</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">int</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Int</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">decode</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">int</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">store</span><span class="p">(</span><span class="n">int</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// JSONSerialization accessors</span>
  <span class="c1">//</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">fragmentsAllowed</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kt">Any</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">withJSONObject</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">fragmentsAllowed</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="c1">//</span>
  <span class="c1">// Private helpers</span>
  <span class="c1">//</span>
  <span class="kd">private</span> <span class="kd">func</span> <span class="n">decode</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Codable</span><span class="o">&gt;</span><span class="p">(</span><span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="nv">as</span><span class="p">:</span> <span class="kt">T</span><span class="o">.</span><span class="k">Type</span> <span class="o">=</span> <span class="kt">T</span><span class="o">.</span><span class="k">self</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">T</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">try</span> <span class="kt">JSONDecoder</span><span class="p">()</span><span class="o">.</span><span class="nf">decode</span><span class="p">(</span><span class="kt">T</span><span class="o">.</span><span class="k">self</span><span class="p">,</span> <span class="nv">from</span><span class="p">:</span> <span class="n">data</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">private</span> <span class="kd">func</span> <span class="n">store</span><span class="o">&lt;</span><span class="kt">T</span><span class="p">:</span> <span class="kt">Codable</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_</span> <span class="nv">value</span><span class="p">:</span> <span class="kt">T</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="n">storage</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONEncoder</span><span class="p">()</span><span class="o">.</span><span class="nf">encode</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="make-your-mocks-small">Make your mocks small</h2>

<p>This is exactly how I’ve seen this problem solved so many times. And now that I’ve written it out myself, I must cry a little. Give me a moment. Please… stop doing this. You can have your mocks. Mock if it makes you happy, but not like this.</p>

<p>If a protocol is large and has basically the same interface as its implementations, then it’s not a protocol, it’s an abstract class. And Swift protocols are not abstract classes. The point of protocols is to adapt types to algorithms. It is not to <a href="https://en.cppreference.com/w/cpp/language/pimpl">recreate the pImpl pattern</a>. You shouldn’t have to modify the protocol and the mock every single time you touch the subject’s API.</p>

<p>A protocol, even for a mock, should capture the parts that vary between implementations, not the parts that are the same. Here’s what actually varies, the parts that read and write data to storage:</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage3/Keychain/Sources/Keychain/KeychainStorage.swift"><em>Source code</em></a></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">KeychainStorage</span><span class="p">:</span> <span class="kt">Actor</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
  <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
  <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The vast majority of <code class="language-plaintext highlighter-rouge">Keychain</code> has nothing to do with the system keychain. Most of the methods implement encoding logic, “business” logic. There is nothing about encoding logic that needs mocking, so it shouldn’t be mocked. You want to test it! Instead, that logic should be moved to a protocol extension and shared between <code class="language-plaintext highlighter-rouge">Keychain</code> and its mock.</p>

<div class="language-swift scroll highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extension</span> <span class="kt">KeychainStorage</span> <span class="p">{</span>
  <span class="c1">// MARK: - String Operations -- Encode as UTF-8</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">string</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">String</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="kt">String</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">encoding</span><span class="p">:</span> <span class="o">.</span><span class="n">utf8</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="kt">String</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">utf8</span><span class="p">),</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// MARK: - JSONSerialization Operations</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">value</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Any</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="nf">data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">else</span> <span class="p">{</span> <span class="k">return</span> <span class="kc">nil</span> <span class="p">}</span>
    <span class="k">return</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">jsonObject</span><span class="p">(</span><span class="nv">with</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">fragmentsAllowed</span><span class="p">])</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="kt">Any</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="kt">JSONSerialization</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">withJSONObject</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">fragmentsAllowed</span><span class="p">])</span>
    <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// MARK: - Public Extensions for Common Types (Bool, Int)</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">bool</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Bool</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">value</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Bool</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">bool</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">bool</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">int</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Int</span><span class="p">?</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">value</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="k">as?</span> <span class="kt">Int</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">int</span><span class="p">:</span> <span class="kt">Int</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="k">try</span> <span class="nf">set</span><span class="p">(</span><span class="nv">value</span><span class="p">:</span> <span class="n">int</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Now the entire mock looks like this:</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage3/Keychain/Sources/Keychain/MockKeychain.swift"><em>Source code</em></a></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">actor</span> <span class="kt">MockKeychain</span><span class="p">:</span> <span class="kt">KeychainStorage</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nv">cache</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Data</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span> <span class="p">}</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span> <span class="n">cache</span><span class="o">.</span><span class="nf">removeAll</span><span class="p">()</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="two-roads-diverged-and-thats-bad">Two roads diverged… and that’s bad</h2>

<p>Mocks that duplicate a large subject’s API do it one of two ways:</p>

<ul>
  <li>They copy a lot of the code from the subject.</li>
  <li>They <em>don’t</em> copy a lot of the code from the subject.</li>
</ul>

<p>Above is an example where I didn’t copy a lot of code from the subject. I reimplemented it in an easy way, which is the most common way I see mocks implemented. I used <code class="language-plaintext highlighter-rouge">JSONEncoder</code> for everything rather than having custom logic for <code class="language-plaintext highlighter-rouge">String</code>. Since it’s symmetrical, it “works,” but the mock has diverged from the thing it’s pretending to be. Consider this code:</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage3/Keychain/Tests/KeychainTests/KeychainTests.swift"><em>Source code</em></a></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">@Test</span> <span class="kd">func</span> <span class="nf">testCrossStorage</span><span class="p">()</span> <span class="k">async</span> <span class="k">throws</span> <span class="p">{</span>
  <span class="c1">// Write it as String</span>
  <span class="k">try</span> <span class="k">await</span> <span class="n">keychain</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">string</span><span class="p">:</span> <span class="s">"abc"</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="s">"key"</span><span class="p">)</span>

  <span class="c1">// Read it as data and decode manually</span>
  <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="k">#require</span><span class="p">(</span><span class="k">try</span> <span class="k">await</span> <span class="n">keychain</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="s">"key"</span><span class="p">))</span>
  <span class="k">let</span> <span class="nv">result</span> <span class="o">=</span> <span class="kt">String</span><span class="p">(</span><span class="nv">decoding</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">as</span><span class="p">:</span> <span class="kt">UTF8</span><span class="o">.</span><span class="k">self</span><span class="p">)</span>

  <span class="cp">#expect(result == "abc")  // testCrossStorage(): Expectation failed: (result → ""abc"") == "abc"</span>
<span class="p">}</span>
</code></pre></div></div>
<p>This test works with the real <code class="language-plaintext highlighter-rouge">Keychain</code>, but it fails with the mock that uses <code class="language-plaintext highlighter-rouge">Codable</code> internally. Nothing here is invalid. It’s a weird way to use the system, but it’s legal and even useful. If the caller wants the value as <code class="language-plaintext highlighter-rouge">Data</code> in order to write it to a file, there’s no reason to round-trip it through <code class="language-plaintext highlighter-rouge">String</code>. They may rely on the fact that they know how it’s encoded.</p>

<p><span class="pullquote-right" data-pullquote="Test your product, not your mocks.">
That’s bad, but the test will fail, so at least it would be caught. The real problem is the reverse. Someone designs their system based on the mock’s behavior <em>rather than what you ship</em>. All the tests will pass, but it will fail in the field. That’s the worst case. You spend all this time building mocks, writing tests, running tests, and what do you get for all that? A bug that’s a real pain to figure out because your tests are lying to you. Test your product, not your mocks.
</span></p>

<p>Of course, instead of re-implementing everything for the mock, I could have copied a lot more code from <code class="language-plaintext highlighter-rouge">Keychain</code> into <code class="language-plaintext highlighter-rouge">MockKeychain</code>, but that’s not any better. It means that today they’re aligned, but as <code class="language-plaintext highlighter-rouge">Keychain</code> evolves the two will almost certainly diverge. If the tests don’t verify all observable behaviors (and that takes a lot more than just “100% code coverage”), then you’ll have the same situation.</p>

<p>Instead, I made the mock protocol small. Just 4 methods:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">protocol</span> <span class="kt">KeychainStorage</span><span class="p">:</span> <span class="kt">Actor</span> <span class="p">{</span>
  <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
  <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span>
  <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Get, set, delete, reset. Those are what the rest of the code needs to operate. Those are exactly the methods I pulled out into some private helpers because they’re kind of ugly.</p>

<h2 id="no-smaller-than-that">No, smaller than that</h2>

<p>But now that we’ve pulled these methods into a protocol, why don’t we go further. We could pull them into their own type. What if <code class="language-plaintext highlighter-rouge">Keychain</code> HAS-A storage rather than IS-A storage?</p>

<p>So the storage is just a struct:</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage4/Keychain/Sources/Keychain/KeychainStorage.swift"><em>Source code</em></a></p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">struct</span> <span class="kt">KeychainStorage</span> <span class="p">{</span>
  <span class="k">let</span> <span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span>

  <span class="nf">init</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span> <span class="k">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="n">identifier</span><span class="p">}</span>

  <span class="c1">// MARK: - All those horrible low-level SecItem... wrappers that I'm not going to bore you with</span>

  <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span> 
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
  <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And the <code class="language-plaintext highlighter-rouge">Keychain</code> uses it.</p>

<p><a href="https://github.com/rnapier/testing/blob/main/mockery/Stage4/Keychain/Sources/Keychain/Keychain.swift"><em>Source code</em></a></p>

<div class="language-swift scroll highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">actor</span> <span class="kt">Keychain</span> <span class="p">{</span>
  <span class="kd">private</span> <span class="k">var</span> <span class="nv">cache</span><span class="p">:</span> <span class="p">[</span><span class="kt">String</span><span class="p">:</span> <span class="kt">Data</span><span class="p">]</span> <span class="o">=</span> <span class="p">[:]</span>
  <span class="kd">private</span> <span class="k">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="kt">KeychainStorage</span><span class="p">?</span>

  <span class="kd">public</span> <span class="nf">init</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="kt">KeychainStorage</span><span class="p">(</span><span class="nv">identifier</span><span class="p">:</span> <span class="n">identifier</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="c1">// For tests, but we'll talk about this much more.</span>
  <span class="nf">init</span><span class="p">(</span><span class="nv">storage</span><span class="p">:</span> <span class="kt">KeychainStorage</span><span class="p">?)</span> <span class="p">{</span>
    <span class="k">self</span><span class="o">.</span><span class="n">storage</span> <span class="o">=</span> <span class="n">storage</span>
  <span class="p">}</span>

  <span class="c1">// MARK: - Data Operations</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">data</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="o">-&gt;</span> <span class="kt">Data</span><span class="p">?</span> <span class="p">{</span>
    <span class="k">if</span> <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">data</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">data</span> <span class="o">=</span> <span class="k">try</span> <span class="n">storage</span><span class="p">?</span><span class="o">.</span><span class="nf">data</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">return</span> <span class="n">data</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="kt">Data</span><span class="p">,</span> <span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">try</span> <span class="n">storage</span><span class="p">?</span><span class="o">.</span><span class="nf">set</span><span class="p">(</span><span class="nv">data</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">removeData</span><span class="p">(</span><span class="k">for</span> <span class="nv">key</span><span class="p">:</span> <span class="kt">String</span><span class="p">)</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="n">cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">try</span> <span class="n">storage</span><span class="p">?</span><span class="o">.</span><span class="nf">removeData</span><span class="p">(</span><span class="nv">for</span><span class="p">:</span> <span class="n">key</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">reset</span><span class="p">()</span> <span class="k">throws</span> <span class="p">{</span>
    <span class="n">cache</span> <span class="o">=</span> <span class="p">[:]</span>
    <span class="k">try</span> <span class="n">storage</span><span class="p">?</span><span class="o">.</span><span class="nf">reset</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Wait, where did the protocol go? What about mocking? Look closely:</p>

<div class="language-swift highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="k">let</span> <span class="nv">storage</span><span class="p">:</span> <span class="kt">KeychainStorage</span><span class="p">?</span>
</code></pre></div></div>

<p>The storage is optional. What happens in this code if it’s nil? Well, it reads and writes to a local dictionary, and doesn’t do anything with the system keychain. Isn’t that exactly what <code class="language-plaintext highlighter-rouge">KeychainMock</code> does?</p>

<p><code class="language-plaintext highlighter-rouge">Keychain</code> is its own mock! All you need to do is set <code class="language-plaintext highlighter-rouge">storage = nil</code>. And if you modify <code class="language-plaintext highlighter-rouge">Keychain</code>, its mock automatically matches because it’s the same thing. The only thing we’ve removed is the little bit that we didn’t want during testing: writing to the real keychain.</p>

<p>This is a shockingly powerful pattern. I call it “self-mocking” and I use it a lot. A whole lot. <code class="language-plaintext highlighter-rouge">Keychain</code> is possibly the most perfect example of it, but many types can benefit from this approach, particularly when you add a few more techniques.</p>

<p>And that’s what this series looks like. This is the simplest form of it, and I’m skipping a few very important details that I’ll discuss soon, like “how do you set <code class="language-plaintext highlighter-rouge">storage = nil</code> without a DI system?” Yeah, that’s an important question.<sup id="fnref:tikitu"><a href="#fn:tikitu" class="footnote" rel="footnote" role="doc-noteref">2</a></sup> And there will be philosophy. So much philosophy. Stay tuned.</p>

<p><a href="https://github.com/rnapier/testing"><em>The repository</em></a></p>
<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:why">
      <p>“Why would anyone build it this way?!?!?” While I’ve invented this version for this article, it’s based on many similar ones I’ve worked with and it’s very natural to get here. The <code class="language-plaintext highlighter-rouge">Data</code> and <code class="language-plaintext highlighter-rouge">String</code> interfaces are built first and are all anyone needs at the time. Later, the <code class="language-plaintext highlighter-rouge">Any</code> interface is added to deal with <code class="language-plaintext highlighter-rouge">[String: Any]</code> dictionaries from the networking stack. It happens to work fine for things like <code class="language-plaintext highlighter-rouge">Int</code> and <code class="language-plaintext highlighter-rouge">Bool</code>, so people start to use the <code class="language-plaintext highlighter-rouge">Any</code> interface for those, and then convenience methods are added. Then someone wants <code class="language-plaintext highlighter-rouge">Codable</code> support, but is afraid to modify the widely used <code class="language-plaintext highlighter-rouge">Keychain</code>, and so adds it locally in their module. Someone else does the same in another module, but instead of <code class="language-plaintext highlighter-rouge">JSONEncoder</code>, uses <code class="language-plaintext highlighter-rouge">PropertyListEncoder</code>. So now if you try to merge all the different interfaces, you’ll find they’re incompatible. <a href="https://martinfowler.com/bliki/Yagni.html">Yagni</a> tells us not to build features we don’t need yet. We only need <code class="language-plaintext highlighter-rouge">Data</code> and <code class="language-plaintext highlighter-rouge">String</code>, and then <code class="language-plaintext highlighter-rouge">[String: Any]</code>, and then just one module needs <code class="language-plaintext highlighter-rouge">Codable</code>, and then… Unifying at any point would introduce risky data migration for thousands of users that no project wants to add to their schedule. And that, my friends, is a downside of yagni that doesn’t get enough discussion. But that’s another blog post. <a href="#fnref:why" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:tikitu">
      <p>Thanks to <a href="https://mastodon.social/@tikitu/114510337278524055">Tikitu</a> for noticing that I accidentally edited out mentioning it. <a href="#fnref:tikitu" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>
</div>


  <footer>
    <p class="meta">
      
      








<time datetime="2025-05-14T21:21:00-04:00" pubdate data-updated="true">14 May 2025</time>
      

<span class="categories">
  
    testing
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/ascii" title="Previous Post: ASCII">&laquo; ASCII</a>
      
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2025 - <a href="mailto:rob@neverwood.org">Rob Napier</a> - <a href="https://twitter.com/cocoaphony">@cocoaphony</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  









<!-- Fathom - simple website analytics - https://usefathom.com -->
<script>
(function(f, a, t, h, o, m){
a[h]=a[h]||function(){
    (a[h].q=a[h].q||[]).push(arguments)
};
o=f.createElement('script'),
m=f.getElementsByTagName('script')[0];
o.async=1; o.src=t; o.id='fathom-script';
m.parentNode.insertBefore(o,m)
})(document, window, '//cdn.usefathom.com/tracker.js', 'fathom');
fathom('set', 'siteId', 'MSRAZWIU');
fathom('trackPageview');
</script>
<!-- / Fathom -->




</body>
</html>
