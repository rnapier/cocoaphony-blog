
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>RNCryptor HMAC Vulnerability (My Security Blunder) - Cocoaphony</title>
  <meta name="author" content="">

  
  <meta name="description" content="Thank you to Allen Mann for discovering the following significant security vulnerability in RNCryptor. The Vulnerability RNCryptor computes the HMAC &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="https://robnapier.net/rncryptor-hmac-vulnerability">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="" rel="alternate" title="Cocoaphony" type="application/atom+xml">
  <link href="https://micro.blog/cocoaphony" rel="me" />
  <link href="https://twitter.com/cocoaphony" rel="me" />
  <link href="https://github.com/robnapier" rel="me" />
  <!-- <script src="/javascripts/modernizr-2.0.js"></script> -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <!-- <script src="/javascripts/octopress.js" type="text/javascript"></script> -->
  <script src='/javascripts/footnotes.js' type="text/javascript"></script>

</head>

<body    class="collapse-sidebar sidebar-footer" >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoaphony</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">RNCryptor HMAC Vulnerability (My Security Blunder)</h1>
    
    
      <p class="meta">
        









<time datetime="2013-01-14T13:52:38-05:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>Thank you to Allen Mann for discovering the following significant security vulnerability in RNCryptor.</p>

<h3>The Vulnerability</h3>


<p><a href="https://github.com/rnapier/RNCryptor">RNCryptor</a> computes the HMAC over the ciphertext only. It does not compute an HMAC over the header, particularly the IV. This allows an attacker to modify the IV and thus manipulate the first block (16-bytes) of decrypted plaintext. This is a major issue, and is exactly the kind of problem that RNCryptor is designed to avoid.</p>

<p>I will be modifying RNCryptor shortly to fix this. This will rev the file version to 2. I will provide a backward-compatibly option to read v1 files (default off). I strongly recommend that developers move to the v2 format.</p>

<p>I will try to get this out as quickly as I can, hopefully this week.</p>

<!-- more -->




<h3>The Lesson</h3>


<p>There is a valuable lesson here. I know this vulnerability in AES. I have <a href="http://cocoaconf.com/conference/sessionDetails/218?confId=7">given talks</a> about it. I&rsquo;ve demonstrated it with <a href="https://github.com/rnapier/security-blunders/blob/master/modaes.py">exploit code</a>. I wrote RNCryptor <em>explicitly</em> to avoid this vulnerability. Yet I screwed up the implementation and so RNCryptor is currently vulnerable to it.</p>

<p>I didn&rsquo;t find this problem myself. I&rsquo;m in the process of designing a different encrypted data format for a client, and I correctly compute the HMAC in that format, and I <em>still</em> didn&rsquo;t clue-in that I&rsquo;d done it wrong in RNCryptor.</p>

<p>How was it found? By someone who didn&rsquo;t just take my word for it. He looked at the implementation, saw the error, wrote his own exploit to prove it to himself, and informed me.</p>

<p>OpenSSL has been written by people very concerned with security. It&rsquo;s been <a href="http://www.kb.cert.org/vuls/byid?searchview&query=openssl">riddled with security bugs</a> over the years. (I wrote RNCryptor directly in response to the serious problems in its AES format.) <a href="http://www.kb.cert.org/vuls/byid?searchview&query=pgp">PGP</a>, <a href="http://www.kb.cert.org/vuls/byid?searchview&query=openssh">SSH</a>, <a href="http://www.kb.cert.org/vuls/byid?searchview&query=kerberos">Kerberos</a>, security protocols, formats, and implementations, even if built by smart people who are aware of the issues, they often have vulnerabilities. Some subtle, some bone-headed (like this one).</p>

<p>So what should you take away from this?</p>

<ol>
<li><p>Trust security systems in proportion to how much public scrutiny they receive. The more closed a system, the more it relies on proprietary and secret techniques, the less you should trust it. Open source systems have many errors. Don&rsquo;t imagine that proprietary systems have fewer; they just aren&rsquo;t found and fixed.</p></li>
<li><p>A security system is only as good as its implementation. The RNCryptor v1 format uses HMAC, which is good, but the implementation is slightly wrong and that creates a vulnerability. Just because your system uses AES and AES is strong doesn&rsquo;t mean that your system is secure.</p></li>
<li><p>You need to educate yourself on the basics of how cryptographic systems work. As a developer you need to be able to evaluate whether the cryptography framework you&rsquo;re using is secure, and even more critically you need to be able to evaluate whether you&rsquo;re using it securely. Common Cryptor&rsquo;s HMAC functions are fine, but if I pass the wrong data, the system is still insecure.</p></li>
<li><p>Assume that any security framework you have will need to be upgraded in the future, possibly in incompatible ways, to address vulnerabilities. Design your project to make upgrading as simple as possible.</p></li>
</ol>

</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Rob Napier</span></span>

      









<time datetime="2013-01-14T13:52:38-05:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    cocoaiphoneSecurity
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/animating-arbitrary-keypaths" title="Previous Post: Animating Arbitrary KeyPaths">&laquo; Animating Arbitrary KeyPaths</a>
      
      
        <a class="basic-alignment right" href="/rncryptor-vulnerability-fix" title="Next Post: Update on RNCryptor vulnerability fix">Update on RNCryptor vulnerability fix &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - <a href="mailto:rob@neverwood.org"></a> - <a href="https://twitter.com/">@</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
