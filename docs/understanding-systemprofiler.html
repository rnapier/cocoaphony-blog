
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Understanding system_profiler - Cocoaphony</title>
  <meta name="author" content="">

  
  <meta name="description" content="It thought I was going to be quiet for two weeks, now three posts in a day. There was a good question on Stack Overflow about getting system &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://localhost:4000/understanding-systemprofiler">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Cocoaphony" type="application/atom+xml">
  <link href="https://micro.blog/cocoaphony" rel="me" />
  <link href="https://twitter.com/cocoaphony" rel="me" />
  <link href="https://github.com/robnapier" rel="me" />
  <!-- <script src="/javascripts/modernizr-2.0.js"></script> -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <!-- <script src="/javascripts/octopress.js" type="text/javascript"></script> -->
  <script src='/javascripts/footnotes.js' type="text/javascript"></script>

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoaphony</a></h1>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>

<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Understanding system_profiler</h1>
    
    
      <p class="meta">
        









<time datetime="2009-06-26T17:25:53-04:00" pubdate data-updated="true"></time>
        
      </p>
    
  </header>


<div class="entry-content"><p>It thought I was going to be quiet for two weeks, now three posts in a day. There was a <a href="http://stackoverflow.com/questions/1050377/machine-id-for-mac-os/1050569#1050569">good question</a> on Stack Overflow about getting system information. The actual question is &ldquo;what does system_profiler actually do?&rdquo;  But it&rsquo;s a good way to show how to begin to understand how any program works on the Mac. Here are some of  the most basic tools of the trade. This is not a deep tutorial on reverse engineering. It&rsquo;s a whirlwind tour of how you begin to attack programs using pretty standard tools. I&rsquo;m not getting into any of the anti-obfuscation tools like Onyx the Black Cat or commercial tools like IDA Pro, or even code injection like SIMBL or F-ScriptAnywhere. When you think you&rsquo;re going to hide how your program works, make sure you research those first. You&rsquo;ll learn quickly how hard that really is. Maybe you should read my thoughts about <a href="http://robnapier.net/blog/obfuscating-cocoa-389">Obfuscating Cocoa</a>.</p>

<!-- more -->


<p>Of course you start with the obvious, &ldquo;man system_profiler&rdquo;. But that doesn&rsquo;t give as much information as we want. So let&rsquo;s tear apart the binary and see what&rsquo;s going on, shall we?</p>

<pre><code class="bash">$ otool -L /usr/sbin/system_profiler
system_profiler:
    /System/Library/PrivateFrameworks/SPSupport.framework/Versions/A/SPSupport (compatibility version 1.0.0, current version 1.0.0)
    /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 677.22.0)
    /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.4)
    /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 227.0.0)
    /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 476.17.0)
</code></pre>

<p>So we see it&rsquo;s using CoreFoundation and a private framework. Let&rsquo;s see what we can learn from that private framework.</p>

<pre><code class="bash">$ otool -L /System/Library/PrivateFrameworks/SPSupport.framework/Versions/A/SPSupport
/System/Library/PrivateFrameworks/SPSupport.framework/Versions/A/SPSupport:
    /System/Library/PrivateFrameworks/SPSupport.framework/Versions/A/SPSupport (compatibility version 1.0.0, current version 1.0.0)
    /System/Library/Frameworks/IOKit.framework/Versions/A/IOKit (compatibility version 1.0.0, current version 275.0.0)
    /System/Library/PrivateFrameworks/DiskManagement.framework/Versions/A/DiskManagement (compatibility version 1.0.0, current version 1.0.0)
    /System/Library/Frameworks/Cocoa.framework/Versions/A/Cocoa (compatibility version 1.0.0, current version 12.0.0)
    /System/Library/Frameworks/SystemConfiguration.framework/Versions/A/SystemConfiguration (compatibility version 1.0.0, current version 212.2.0)
    /usr/lib/libcurl.4.dylib (compatibility version 5.0.0, current version 5.0.0)
    /usr/lib/libz.1.dylib (compatibility version 1.0.0, current version 1.2.3)
    /usr/lib/libgcc_s.1.dylib (compatibility version 1.0.0, current version 1.0.0)
    /usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 111.1.4)
    /usr/lib/libobjc.A.dylib (compatibility version 1.0.0, current version 227.0.0)
    /System/Library/Frameworks/CoreFoundation.framework/Versions/A/CoreFoundation (compatibility version 150.0.0, current version 476.17.0)
    /System/Library/Frameworks/AppKit.framework/Versions/C/AppKit (compatibility version 45.0.0, current version 949.45.0)
    /System/Library/Frameworks/Foundation.framework/Versions/C/Foundation (compatibility version 300.0.0, current version 677.22.0)
</code></pre>

<p>We see it&rsquo;s in Cocoa. Nice, we can use <a href="http://www.codethecode.com/projects/class-dump/">class-dump</a> on it. And we see a bunch of public and private frameworks in there. We won&rsquo;t go into all of those here. But you can tear them apart using the same techniques we&rsquo;re going to use on DiskManagement:</p>

<pre><code class="objc">$ class-dump /System/Library/PrivateFrameworks/DiskManagement.framework/Versions/A/DiskManagement
...
@interface DMManager : NSObject
{
    id _instPriv;
}

+ (BOOL)systemResourcesSufficient;
+ (BOOL)systemAtMountPoint:(id)fp8 lowVersion:(int)fp12 lowInclusive:(BOOL)fp16 highVersion:(int)fp20 highInclusive:(BOOL)fp24;
+ (id)sharedManager;
+ (id)sharedManagerWithoutAuthentication;
+ (void)initialize;
- (id)initWithAuthentication:(BOOL)fp8;
- (void)dealloc;
- (id)agent;
- (void)updateGID:(int)fp8;
- (id)getPartitionStartLocationForDisk:(id)fp8;
- (id)getInfoForChildrenOfDisk:(id)fp8 sortedBy:(id)fp12;
- (void)enableVirtualDisks;
- (void)disableVirtualDisks;
- (id)diskWithIdentifier:(id)fp8;
- (id)diskWithDiskIdentifier:(id)fp8;
- (id)diskWithDeviceTreePath:(id)fp8;
- (id)diskWithUUID:(id)fp8;
- (id)diskWithUUIDInDisk:(id)fp8;
- (id)diskWithDisk:(id)fp8;
- (id)rootDisk;
...
</code></pre>

<p>Hey, that might be handy in trying to understand unique things about our system (the thing we happen to be interested in). You can continue this approach through any of the pieces that look interesting. Of course you&rsquo;re going to have to guess a bit about types, but you can call these methods in your code and then ask the resulting object for its -class.</p>

<p>We could do this all day (and you probably will, chasing down various libraries that look interesting and writing small projects to explore them), but let&rsquo;s take a completely different track. Let&rsquo;s go from static to dynamic and see what system_profiler actually <b>does</b> when it runs.</p>

<pre><code class="c">$ sudo dtruss /usr/sbin/system_profiler
...
stat("/System/Library/PrivateFrameworks/SPSupport.framework/Versions/A/SPSupport\0", 0xBFFFD3E8, 0xFFFFFFFFBFFFBCA4)         = 0 0
open("/System/Library/PrivateFrameworks/SPSupport.framework/Versions/A/SPSupport\0", 0x0, 0x0)       = 3 0
pread(0x3, "\312\376\272\276\0", 0x1000, 0x0)        = 4096 0
pread(0x3, "\316\372\355\376\a\0", 0x1000, 0x1000)       = 4096 0
mmap(0x3F000000, 0xD000, 0x5, 0x12, 0x3, 0x100000000)        = 0x3F000000 0
...
open_nocancel("/System/Library/SystemProfiler/SPBluetoothReporter.spreporter/Contents\0", 0x100004, 0x316310)        = 3 0
...
</code></pre>

<p>So we see all the frameworks it uses, and hey, /System/Library/SystemProfiler sure looks interesting. I wonder what we might do with that?</p>

<pre><code class="objc">$ class-dump /System/Library/SystemProfiler/SPNetworkReporter.spreporter/Contents/MacOS/SPNetworkReporter
struct __SCDynamicStore;
...
@interface SPNetworkReporter : SPReporter
{
    struct __SCDynamicStore *_scStore;
    NSMutableDictionary *_localizedServiceNames;
}

- (id)_hardwareDictionaryForInterface:(id)fp8;
- (id)_proxyDictionaryForServiceID:(id)fp8;
- (id)_ipv4DictionaryForServiceID:(id)fp8;
- (id)_ipv6DictionaryForServiceID:(id)fp8;
- (id)_dnsDictionaryForServiceID:(id)fp8;
- (id)_appleTalkDictionaryForServiceID:(id)fp8;
- (id)_ethernetDictionaryForServiceID:(id)fp8 interfaceID:(id)fp12;
- (id)_dhcpDictionaryForServiceID:(id)fp8;
- (id)_dictionaryForServiceID:(id)fp8;
- (id)updateDictionary:(id)fp8;
- (void)dealloc;

@end
</code></pre>

<p>OK, but what does this one really do? Maybe if if we had a nice way to disassemble it&hellip;. Like maybe <a href="http://otx.osxninja.com/">otx</a>.</p>

<pre><code class="c-objdump">$ otx /System/Library/SystemProfiler/SPNetworkReporter.spreporter/Contents/MacOS/SPNetworkReporter
...
-(id)[SPNetworkReporter _hardwareDictionaryForInterface:]
    +0  00000f0e  55             pushl    %ebp
    +1  00000f0f  89e5           movl     %esp,%ebp
    +3  00000f11  57             pushl    %edi
    +4  00000f12  56             pushl    %esi
    +5  00000f13  53             pushl    %ebx
    +6  00000f14  e800000000     calll    0x00000f19
   +11  00000f19  5b             popl     %ebx
   +12  00000f1a  83ec5c         subl     $0x5c,%esp
   +15  00000f1d  8b83e7300000   movl     0x000030e7(%ebx),%eax
   +21  00000f23  89442404       movl     %eax,0x04(%esp)
   +25  00000f27  8b8377310000   movl     0x00003177(%ebx),%eax
   +31  00000f2d  890424         movl     %eax,(%esp)
   +34  00000f30  e8c3410000     calll    0x000050f8               +[NSMutableDictionary dictionary]
   +39  00000f35  89c7           movl     %eax,%edi
   +41  00000f37  8b4510         movl     0x10(%ebp),%eax
   +44  00000f3a  85c0           testl    %eax,%eax
   +46  00000f3c  0f8486020000   jel      0x000011c8
   +52  00000f42  8d45e4         leal     0xe4(%ebp),%eax
   +55  00000f45  89442404       movl     %eax,0x04(%esp)
   +59  00000f49  8b8313410000   movl     0x00004113(%ebx),%eax
   +65  00000f4f  8b00           movl     (%eax),%eax
   +67  00000f51  890424         movl     %eax,(%esp)
   +70  00000f54  e84a410000     calll    0x000050a3               _IOMasterPort
...
</code></pre>

<p>Digging through we&rsquo;ll see a lot of stuff starting &ldquo;IO.&rdquo; Just a little googling will teach us that means IOKit. So maybe that&rsquo;s going to be a good place to study in understanding this better.</p>

<p>This is just the start, and the goal is to get people thinking in the right way and get some basic tools in their hands. These aren&rsquo;t black-hat tools. These are the basic tools of the trade. Any experienced Mac developer should know enough to tear apart Apple&rsquo;s code to figure out how they&rsquo;re doing what they do. That let&rsquo;s us write better Mac apps, even if we avoid using the private interfaces.</p>
</div>


  <footer>
    <p class="meta">
      
<span class="byline author vcard">Posted by <span class="fn">Rob Napier</span></span>

      









<time datetime="2009-06-26T17:25:53-04:00" pubdate data-updated="true"></time>
      

<span class="categories">
  
    cocoa
  
</span>


    </p>
    
      <div class="sharing">
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/obfuscating-cocoa" title="Previous Post: Obfuscating Cocoa">&laquo; Obfuscating Cocoa</a>
      
      
        <a class="basic-alignment right" href="/broader-use-of-objc" title="Next Post: Broader use of ObjC">Broader use of ObjC &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    
  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - <a href="mailto:rob@neverwood.org"></a> - <a href="https://twitter.com/">@</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
