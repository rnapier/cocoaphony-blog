
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Even Faster Bezier - Cocoaphony</title>
  <meta name="author" content="Rob Napier">

  
  <meta name="description" content="When last we looked at Bézier curve calculations, we were able to calculate five million points in about 0.6s (~8.3Mp/s or megapoints-per-second). &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://robnapier.net/faster-bezier">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Cocoaphony" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-8553355-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Cocoaphony</a></h1>
  
    <h2>Mac and iPhone, on the brain</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:robnapier.net" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Even Faster Bezier</h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-06T12:53:40-05:00" pubdate data-updated="true">Mar 6<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>When <a href="/fast-bezier-intro-701">last we looked at Bézier curve calculations</a>, we were able to calculate five million points in about 0.6s (~8.3Mp/s or megapoints-per-second). That&rsquo;s 1000 points per curve, 100 curves, at 50fps. That was 5x faster than the original <code>-Os</code> optimized function. But we&rsquo;re just getting warmed up. We haven&rsquo;t yet gotten half of the performance available.</p>

<!-- more -->


<p>In this installment, we&rsquo;ll look at improving our algorithm. The code is available on <a href="https://github.com/rnapier/cocoaphony/tree/master/BezierPerf">github</a>.</p>

<p>We tried the Accelerate framework, but it didn&rsquo;t help us. The cost of the function calls obliterated our gains. What can we do? First, let&rsquo;s look at the code again, and see if we&rsquo;re doing anything foolish.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="n">CGFloat</span> <span class="nf">BezierNoPow</span><span class="p">(</span><span class="n">CGFloat</span> <span class="n">t</span><span class="p">,</span> <span class="n">CGFloat</span> <span class="n">P0</span><span class="p">,</span> <span class="n">CGFloat</span> <span class="n">P1</span><span class="p">,</span>
</span><span class='line'>                                  <span class="n">CGFloat</span> <span class="n">P2</span><span class="p">,</span> <span class="n">CGFloat</span> <span class="n">P3</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span>
</span><span class='line'>    <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">P0</span>
</span><span class='line'>    <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span> <span class="o">*</span> <span class="n">P1</span>
</span><span class='line'>    <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span> <span class="o">*</span> <span class="n">P2</span>
</span><span class='line'>    <span class="o">+</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span> <span class="o">*</span> <span class="n">P3</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">copyBezierNoPow</span><span class="p">(</span><span class="n">CGPoint</span> <span class="n">P0</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P1</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P2</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P3</span><span class="p">,</span>
</span><span class='line'>                             <span class="n">CGPoint</span> <span class="o">**</span><span class="n">results</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="o">*</span><span class="n">results</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="n">kSteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">CGPoint</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="n">kSteps</span><span class="p">;</span> <span class="o">++</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">x</span> <span class="o">=</span> <span class="n">BezierNoPow</span><span class="p">((</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">step</span><span class="o">/</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">kSteps</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">P0</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P1</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P2</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">P3</span><span class="p">.</span><span class="n">x</span><span class="p">);</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">y</span> <span class="o">=</span> <span class="n">BezierNoPow</span><span class="p">((</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">step</span><span class="o">/</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">kSteps</span><span class="p">,</span>
</span><span class='line'>                            <span class="n">P0</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P1</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P2</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">P3</span><span class="p">.</span><span class="n">y</span><span class="p">);</span>
</span><span class='line'>    <span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">CGPointMake</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">kSteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how we&rsquo;re recalculating a lot of things. For example, we calculate <code>(1-t)*(1-t)*(1-t)</code> twice with the same <code>t</code>. That can&rsquo;t be good. What if we factor out the part that doesn&rsquo;t change between <em>x</em> and <em>y</em>?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">copyBezierXY</span><span class="p">(</span><span class="n">CGPoint</span> <span class="n">P0</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P1</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P2</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P3</span><span class="p">,</span>
</span><span class='line'>                          <span class="n">CGPoint</span> <span class="o">**</span><span class="n">results</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="o">*</span><span class="n">results</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">((</span><span class="n">kSteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">CGPoint</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="n">kSteps</span><span class="p">;</span> <span class="o">++</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">step</span><span class="o">/</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">kSteps</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">C0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">);</span> <span class="c1">// * P0</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">C1</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span> <span class="c1">// * P1</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">C2</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="c1">// * P2</span>
</span><span class='line'>    <span class="n">CGFloat</span> <span class="n">C3</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="c1">// * P3;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">CGPoint</span> <span class="n">point</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">C0</span><span class="o">*</span><span class="n">P0</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">C1</span><span class="o">*</span><span class="n">P1</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">C2</span><span class="o">*</span><span class="n">P2</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">C3</span><span class="o">*</span><span class="n">P3</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>      <span class="n">C0</span><span class="o">*</span><span class="n">P0</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">C1</span><span class="o">*</span><span class="n">P1</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">C2</span><span class="o">*</span><span class="n">P2</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">C3</span><span class="o">*</span><span class="n">P3</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">kSteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hey, that gets us from 0.6s to 0.5s (10Mp/s). A 17% improvement&rsquo;s pretty good. But let&rsquo;s think about this some more. The values <code>t</code> can take are exactly dependent on <code>kSteps</code>, which is a constant for the program. And since the <code>C</code> variables depend only on <code>t</code>, that means they&rsquo;re a fixed set as well. We should only have to calculate them once for the whole program. That seems a lot of work we don&rsquo;t need to do. Let&rsquo;s see how it turns out.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='objc'><span class='line'><span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">copyBezierTable</span><span class="p">(</span><span class="n">CGPoint</span> <span class="n">P0</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P1</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P2</span><span class="p">,</span> <span class="n">CGPoint</span> <span class="n">P3</span><span class="p">,</span>
</span><span class='line'>                             <span class="n">CGPoint</span> <span class="o">**</span><span class="n">results</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="o">*</span><span class="n">results</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">((</span><span class="n">kSteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">CGPoint</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">static</span> <span class="n">CGFloat</span> <span class="n">C0</span><span class="p">[</span><span class="n">kSteps</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span class='line'>  <span class="k">static</span> <span class="n">CGFloat</span> <span class="n">C1</span><span class="p">[</span><span class="n">kSteps</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span class='line'>  <span class="k">static</span> <span class="n">CGFloat</span> <span class="n">C2</span><span class="p">[</span><span class="n">kSteps</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span class='line'>  <span class="k">static</span> <span class="n">CGFloat</span> <span class="n">C3</span><span class="p">[</span><span class="n">kSteps</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span><span class='line'>  <span class="k">static</span> <span class="kt">int</span> <span class="n">sInitialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sInitialized</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="n">kSteps</span><span class="p">;</span> <span class="o">++</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">CGFloat</span> <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">step</span><span class="o">/</span><span class="p">(</span><span class="n">CGFloat</span><span class="p">)</span><span class="n">kSteps</span><span class="p">;</span>
</span><span class='line'>      <span class="n">C0</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">);</span> <span class="c1">// * P0</span>
</span><span class='line'>      <span class="n">C1</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">;</span> <span class="c1">// * P1</span>
</span><span class='line'>      <span class="n">C2</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">t</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="c1">// * P2</span>
</span><span class='line'>      <span class="n">C3</span><span class="p">[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="o">*</span><span class="n">t</span><span class="p">;</span> <span class="c1">// * P3;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">sInitialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">step</span> <span class="o">&lt;=</span> <span class="n">kSteps</span><span class="p">;</span> <span class="o">++</span><span class="n">step</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">CGPoint</span> <span class="n">point</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>      <span class="n">C0</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P0</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P1</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P2</span><span class="p">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">C3</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P3</span><span class="p">.</span><span class="n">x</span><span class="p">,</span>
</span><span class='line'>      <span class="n">C0</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P0</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">C1</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P1</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">C2</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P2</span><span class="p">.</span><span class="n">y</span> <span class="o">+</span> <span class="n">C3</span><span class="p">[</span><span class="n">step</span><span class="p">]</span><span class="o">*</span><span class="n">P3</span><span class="p">.</span><span class="n">y</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="p">(</span><span class="o">*</span><span class="n">results</span><span class="p">)[</span><span class="n">step</span><span class="p">]</span> <span class="o">=</span> <span class="n">point</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">kSteps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>0.16s. 31Mp/s. That&rsquo;s over 3x faster by just calculating the piece that changes.</p>

<p><strong>Lesson 2: In most cases, your biggest improvements will come from changing your algorithm. Whenever possible, get expensive things out of loops. Don&rsquo;t make a calculation fast if you can get rid of the calculation entirely. Remember that if you&rsquo;re called many times, that&rsquo;s the same as a loop.</strong></p>

<p>The cost of this is 4 floats (16 bytes) per step to store the constants. So for a 1000 step curve, that&rsquo;s less than 16kB. Not a bad investment on iOS. This cost is for as many curves as you want, as long as they all use the same step size. Of course, if you want different numbers of steps, you could just pass a scale variable to calculate every other point, every fourth point, etc. But by the time we&rsquo;re done optimizing this (and there&rsquo;s still plenty of performance left to unlock), you may find that it&rsquo;s faster and easier just to calculate the same number of points for all curves.</p>

<p>There is another common way to speed up Bézier calculation. Hannu Kankaanpää wrote an excellent article explaining <a href="http://www.niksula.hut.fi/~hkankaan/Homepages/bezierfast.html">forward differencing using a Taylor series</a>. His approach is fast. About 50-60% faster than <code>copyBezierXY()</code>. But <code>copyBezierTable()</code> is about twice as fast as forward differencing if you calculate a lot of curves with the same step size. Forward differencing is fast if you have one incredibly expensive curve to calculate (say a large Bézier surface). But it loses when you need to calculate a lot of curves. Factoring out everything but the points themselves into a pre-calcuated table lets you skip almost all the work. And that&rsquo;s the goal.</p>

<p>We <em>still</em> haven&rsquo;t pulled out Instruments, and we&rsquo;re still writing in portable C. I wonder what we might get if we go off-road and write directly for the NEON coprocessor. Yes, that means we&rsquo;re moving onto ARM assembler in the next post. Think you can&rsquo;t beat the compiler? Think it&rsquo;s not worth it to try? Think again.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Rob Napier</span></span>

      








  


<time datetime="2012-03-06T12:53:40-05:00" pubdate data-updated="true">Mar 6<span>th</span>, 2012</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/cocoa/'>cocoa</a>, <a class='category' href='/blog/categories/iphone/'>iphone</a>, <a class='category' href='/blog/categories/performance/'>performance</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://robnapier.net/faster-bezier/" data-via="cocoaphony" data-counturl="http://robnapier.net/faster-bezier/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/fast-bezier-intro/" title="Previous Post: Introduction to Fast Bezier (and trying the Accelerate.framework)">&laquo; Introduction to Fast Bezier (and trying the Accelerate.framework)</a>
      
      
        <a class="basic-alignment right" href="/triangle-cocoaheads-march/" title="Next Post: Triangle CocoaHeads (and Building a (Core) Foundation)">Triangle CocoaHeads (and Building a (Core) Foundation) &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
	<h1>Coming Jan. 2014</h1>
  <a href="http://www.amazon.com/dp/1118818342"><img src="/images/ios7_ptl_cover.png" alt="iOS 7 Programing Pushing the Limits" /></a>
</section><section>
  <h1><a href="http://renaissance.io/2014">Renaissance 2014</a></h1>
    <p>I'll be discussing <a href="http://renaissance.io/2014/sessions/get_security_and_privacy_right">security best practices</a> at the Renaissance conference, January 29-31, 2014 in San Francisco.</p>
</section><section>
  <h1>About Cocoaphony</h1>
  <p>Rob is a builder of treehouses, hiker, proud father, and from time to time, a Mac and iPhone developer. Cocoaphony is where he pontificates on various issues fascinating to Cocoa developers, and occasionally other topics of technical interest.</p>
</section>

  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - <a href="mailto:robnapier@gmail.com">Rob Napier</a> - <a href="https://twitter.com/cocoaphony">@cocoaphony</a> - 
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
